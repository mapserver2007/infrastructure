- name: copy restore files
  copy: src={{ item.src }} dest={{ item.dest }}
  with_items:
    - { src: 'ansible', dest: '/home/vagrant/restore/webstream-mysql' }
    - { src: "{{ lookup('pipe', 'ls -1 backupfile/*.tar') }}", dest: '/home/vagrant/restore/webstream-mysql/backup.tar' }
- name: clear docker container
  shell: "{{ item.shell }}"
  with_items:
    - { shell: "docker ps -a | grep data_mysql | awk '{if (length($1) > 0) system(\"sudo docker rm -f \" $1)}'" }
    - { shell: "docker ps -a | grep webstream-mysql | awk '{if (length($1) > 0) system(\"sudo docker rm -f \" $1)}'" }
  sudo: yes
- name: docker run
  shell: "{{ item.shell }}"
  with_items:
    - { shell: "docker run -itd -v /mnt/docker/mysql --name data_mysql docker/data" }
    - { shell: "docker run -itd --privileged --volumes-from data_mysql --name webstream-mysql docker/mysql /sbin/init" }
  sudo: yes
- name: copy ansible files to container (mysql)
  shell: tar -cv * | sudo docker exec -i webstream-mysql tar x -C /root/ansible chdir=restore/webstream-mysql/ansible
  sudo: yes
- name: docker provision for mysql
  shell: docker exec -it webstream-mysql ansible-playbook -i "localhost," /root/ansible/settings.yml
  sudo: yes
- name: mysql data restore
  shell: cat restore/webstream-mysql/backup.tar | sudo docker exec -i data_mysql tar x -C /
  sudo: yes
- name: restart mysql
  shell: docker exec -it webstream-mysql sh -c 'systemctl restart mysql.service'
  sudo: yes
