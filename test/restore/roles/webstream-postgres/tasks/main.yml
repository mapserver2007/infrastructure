- name: copy ansible files
  copy: src={{ item.src }} dest={{ item.dest }}
  with_items:
    - { src: 'ansible', dest: '/home/vagrant/restore/webstream-postgres' }
    - { src: "{{ lookup('pipe', 'ls -1 backupfile/*.tar') }}", dest: '/home/vagrant/restore/webstream-postgres/backup.tar' }
- name: clear docker container
  shell: "{{ item.shell }}"
  with_items:
    - { shell: "docker ps -a | grep data_postgres | awk '{if (length($1) > 0) system(\"sudo docker rm -f \" $1)}'" }
    - { shell: "docker ps -a | grep webstream-postgres | awk '{if (length($1) > 0) system(\"sudo docker rm -f \" $1)}'" }
  sudo: yes
- name: docker run
  shell: "{{ item.shell }}"
  with_items:
    - { shell: "docker run -itd -v /mnt/docker/postgres --name data_postgres docker/data" }
    - { shell: "docker run -itd --privileged --volumes-from data_postgres --name webstream-postgres docker/postgres /sbin/init" }
  sudo: yes
- name: copy ansible files to container (postgres)
  shell: tar -cv * | sudo docker exec -i webstream-postgres tar x -C /root/ansible chdir=restore/webstream-postgres/ansible
  sudo: yes
- name: docker provision for postgres
  shell: docker exec -it webstream-postgres ansible-playbook -i "localhost," /root/ansible/settings.yml
  sudo: yes
- name: postgres data restore
  shell: cat restore/webstream-postgres/backup.tar | sudo docker exec -i data_postgres tar x -C /
  sudo: yes
- name: restart postgres
  shell: docker exec -it webstream-postgres sh -c 'systemctl restart postgresql-9.4.service'
  sudo: yes
