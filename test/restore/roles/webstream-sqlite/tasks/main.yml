- name: create restore directory
  file: path=/home/vagrant/restore/webstream-sqlite state=directory
- name: copy restore files
  copy: src={{ item.src }} dest={{ item.dest }}
  with_items:
    - { src: "{{ lookup('pipe', 'ls -1 backupfile/*.tar') }}", dest: '/home/vagrant/restore/webstream-sqlite/backup.tar' }
- name: clear docker container
  shell: "{{ item.shell }}"
  with_items:
    - { shell: "docker ps -a | grep data_sqlite | awk '{if (length($1) > 0) system(\"sudo docker rm -f \" $1)}'" }
    - { shell: "docker ps -a | grep webstream-sqlite | awk '{if (length($1) > 0) system(\"sudo docker rm -f \" $1)}'" }
  sudo: yes
- name: docker run
  shell: "{{ item.shell }}"
  with_items:
    - { shell: "docker run -itd -v /mnt/docker/sqlite --name data_sqlite docker/data" }
    - { shell: "docker run -itd --privileged --volumes-from data_sqlite --name webstream-sqlite docker/sqlite /sbin/init" }
  sudo: yes
- name: sqlite data restore
  shell: cat restore/webstream-sqlite/backup.tar | sudo docker exec -i data_sqlite tar x -C /
  sudo: yes
